<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <title>Me & You - Login</title>

    <link
      rel="manifest"
      href="{% static 'manifest.json' %}"
      crossorigin="use-credentials"
    />
    <link rel="icon" href="{% static 'icons/icon.jpg' %}" />
    <link rel="apple-touch-icon" href="{% static 'icons/icon.jpg' %}" />
    <meta name="theme-color" content="#e75480" />

    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        min-height: 100vh;
        min-width: 100vw;
        font-family: "Outfit", sans-serif;
        background: #0d0d0d;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .main-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      .login-container {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 40px 30px;
        width: 100%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        margin-bottom: 28px;
      }

      .login-container svg {
        width: 48px;
        height: 48px;
        margin-bottom: 10px;
        fill: #ff4c61; /* updated to red */
      }

      h1 {
        font-size: 26px;
        margin-bottom: 25px;
        font-weight: 600;
        color: #ffffff;
      }

      input {
        width: 100%;
        padding: 14px;
        margin: 10px 0;
        border: none;
        border-radius: 12px;
        background: #1e1e1e;
        color: white;
        font-size: 15px;
        outline: none;
      }

      button {
        width: 100%;
        padding: 14px;
        margin-top: 20px;
        background: #ff4c61; /* updated to red */
        border: none;
        color: white;
        font-size: 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      button:hover {
        background: #ff6e7c; /* softer red on hover */
      }

      .pwa-actions {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 400px;
        gap: 0;
      }

      #installBtn {
        display: none;
        margin-top: 0;
        width: 100%;
        padding: 14px;
        background: linear-gradient(90deg, #ff4c61 60%, #ff7182 100%);
        border: none;
        color: white;
        font-size: 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s ease, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      #installBtn.show {
        display: block;
      }

      #install-tip,
      #ios-pwa-tip {
        display: none;
        margin-top: 12px;
        background: #222;
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 15px;
        text-align: center;
        width: 100%;
      }

      @media (max-width: 500px) {
        .main-content,
        .login-container,
        .pwa-actions {
          max-width: 98vw;
          width: 98vw;
        }

        .login-container {
          padding: 28px 8px;
        }

        h1 {
          font-size: 22px;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div class="login-container">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
                 2 6.5 3.5 5 5.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 
                 14.96 5 16.5 5 18.5 5 20 6.5 20 8.5c0 3.78-3.4 
                 6.86-8.55 11.54L12 21.35z"
          />
        </svg>

        <h1>Me & You</h1>

        <form onsubmit="startSession(event)">
          <input type="text" name="partner1" placeholder="Your Name" required />
          <input
            type="text"
            name="partner2"
            placeholder="Partner's Name"
            required
          />
          <input type="text" name="secret" placeholder="Secret Word" required />
          <button type="submit">Start</button>
        </form>
      </div>
      <div class="pwa-actions">
        <button id="installBtn" type="button">
          <span style="font-size: 1.3em; vertical-align: middle"
            >&#x1F4E6;</span
          >
          Install App
        </button>
        <div id="install-tip">
          Tip: On desktop, click "Install App" or use your browser's menu to
          install.<br />
          On Android, tap "Install App" when prompted.
        </div>
        <div id="ios-pwa-tip">
          To install this app on your iPhone/iPad, tap
          <span style="font-size: 1.2em">&#x1F5D2;</span> or
          <span style="font-size: 1.2em">&#x2191;</span> and then "Add to Home
          Screen".
        </div>
      </div>
    </div>

    <script>
      async function startSession(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          const res = await fetch("/api/login/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              partner1_name: formData.get("partner1"),
              partner2_name: formData.get("partner2"),
              secret_word: formData.get("secret"),
            }),
          });

          const data = await res.json();

          if (data.success) {
            // Store session data
            localStorage.setItem("session", JSON.stringify(data.session));
            // Redirect to modes
            window.location.href = data.redirect;
          } else {
            alert(data.detail || "Login failed");
          }
        } catch (err) {
          console.error("Login error:", err);
          alert("Login failed");
        }
      }

      // PWA Installation
      let deferredPrompt;

      function isIos() {
        return /iphone|ipad|ipod/i.test(navigator.userAgent);
      }
      function isInStandaloneMode() {
        return "standalone" in window.navigator && window.navigator.standalone;
      }

      window.addEventListener("DOMContentLoaded", () => {
        // Show iOS tip if on iOS and not installed
        if (isIos() && !isInStandaloneMode()) {
          document.getElementById("ios-pwa-tip").style.display = "block";
          document.getElementById("install-tip").style.display = "none";
          document.getElementById("installBtn").style.display = "none";
        }
      });

      window.addEventListener("beforeinstallprompt", (e) => {
        if (isIos()) return; // Don't show install prompt/button on iOS
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById("installBtn").classList.add("show");
        document.getElementById("install-tip").style.display = "block";
        document.getElementById("ios-pwa-tip").style.display = "none";
      });

      document.getElementById("installBtn").addEventListener("click", () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choice) => {
            if (choice.outcome === "accepted") {
              console.log("App installed");
            }
            deferredPrompt = null;
            document.getElementById("installBtn").classList.remove("show");
            document.getElementById("install-tip").style.display = "none";
          });
        }
      });

      // Service Worker Registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", async () => {
          try {
            await navigator.serviceWorker.register(
              "/static/service-worker.js",
              {
                scope: "/static/",
              }
            );
          } catch (err) {
            console.error("Service Worker registration failed:", err);
          }
        });
      }
    </script>
  </body>
</html>
